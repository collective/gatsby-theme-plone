{"version":3,"sources":["../../src/db/nodes.js"],"names":["_","require","store","backend","process","env","GATSBY_DB_NODES","nodesDb","Error","module","exports","loadNodeContent","node","isString","internal","content","Promise","resolve","plugin","getState","flattenedPlugins","find","plug","name","owner","then"],"mappings":";;AAAA,MAAMA,CAAC,GAAGC,OAAO,CAAE,QAAF,CAAjB;;iBACkBA,OAAO,CAAE,UAAF,C;MAAjBC,K,YAAAA,K;;AAER,MAAMC,OAAO,GAAGC,OAAO,CAACC,GAAR,CAAYC,eAAZ,IAAgC,OAAhD;AACA,IAAIC,OAAJ;;AACA,QAAQJ,OAAR;AACE,OAAM,OAAN;AACEI,IAAAA,OAAO,GAAGN,OAAO,CAAE,gBAAF,CAAjB;AACA;;AACF,OAAM,MAAN;AACEM,IAAAA,OAAO,GAAGN,OAAO,CAAE,cAAF,CAAjB;AACA;;AACF;AACE,UAAM,IAAIO,KAAJ,CACH,iEADG,CAAN;AARJ;;AAaAC,MAAM,CAACC,OAAP,qBAAsBH,OAAtB;AACAE,MAAM,CAACC,OAAP,CAAeP,OAAf,GAAyBA,OAAzB;AAEA;;;;;;;AAMAM,MAAM,CAACC,OAAP,CAAeC,eAAf,GAAiCC,IAAI,IAAI;AACvC,MAAIZ,CAAC,CAACa,QAAF,CAAWD,IAAI,CAACE,QAAL,CAAcC,OAAzB,CAAJ,EAAuC;AACrC,WAAOC,OAAO,CAACC,OAAR,CAAgBL,IAAI,CAACE,QAAL,CAAcC,OAA9B,CAAP;AACD,GAFD,MAEO;AACL,WAAO,IAAIC,OAAJ,CAAYC,OAAO,IAAI;AAC5B;AACA,YAAMC,MAAM,GAAGhB,KAAK,CACjBiB,QADY,GAEZC,gBAFY,CAEKC,IAFL,CAEUC,IAAI,IAAIA,IAAI,CAACC,IAAL,KAAcX,IAAI,CAACE,QAAL,CAAcU,KAF9C,CAAf;;AAF4B,wBAKAvB,OAAO,CAACiB,MAAM,CAACD,OAAR,CALP;AAAA,YAKpBN,eALoB,aAKpBA,eALoB;;AAM5B,UAAI,CAACA,eAAL,EAAsB;AACpB,cAAM,IAAIH,KAAJ,CACH,sDAAqDU,MAAM,CAACK,IAAK,EAD9D,CAAN;AAGD;;AAED,aAAOZ,eAAe,CAACC,IAAD,CAAf,CAAsBa,IAAtB,CAA2BV,OAAO,IAAI;AAC3C;AACAE,QAAAA,OAAO,CAACF,OAAD,CAAP;AACD,OAHM,CAAP;AAID,KAhBM,CAAP;AAiBD;AACF,CAtBD","sourcesContent":["const _ = require(`lodash`)\nconst { store } = require(`../redux`)\n\nconst backend = process.env.GATSBY_DB_NODES || `redux`\nlet nodesDb\nswitch (backend) {\n  case `redux`:\n    nodesDb = require(`../redux/nodes`)\n    break\n  case `loki`:\n    nodesDb = require(`./loki/nodes`)\n    break\n  default:\n    throw new Error(\n      `Unsupported DB nodes backend (value of env var GATSBY_DB_NODES)`\n    )\n}\n\nmodule.exports = { ...nodesDb }\nmodule.exports.backend = backend\n\n/**\n * Get content for a node from the plugin that created it.\n *\n * @param {Object} node\n * @returns {promise}\n */\nmodule.exports.loadNodeContent = node => {\n  if (_.isString(node.internal.content)) {\n    return Promise.resolve(node.internal.content)\n  } else {\n    return new Promise(resolve => {\n      // Load plugin's loader function\n      const plugin = store\n        .getState()\n        .flattenedPlugins.find(plug => plug.name === node.internal.owner)\n      const { loadNodeContent } = require(plugin.resolve)\n      if (!loadNodeContent) {\n        throw new Error(\n          `Could not find function loadNodeContent for plugin ${plugin.name}`\n        )\n      }\n\n      return loadNodeContent(node).then(content => {\n        // TODO update node's content field here.\n        resolve(content)\n      })\n    })\n  }\n}\n"],"file":"nodes.js"}